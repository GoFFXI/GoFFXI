name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.25.3'
  FFXI_RES_PATH: resources

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build all binaries
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          # Set file extension for Windows
          EXT=""
          if [ "${{ matrix.os }}" = "windows" ]; then
            EXT=".exe"
          fi

          # Build all of the binaries
          for BINARY in lobby-auth lobby-data lobby-view map-router map-instance; do
            OUTPUT_NAME="${BINARY}-${{ matrix.os }}-${{ matrix.arch }}${EXT}"
            echo "Building ${OUTPUT_NAME}..."
            go build -v -o "${OUTPUT_NAME}" ./cmd/${BINARY}
          done

          # List built binaries for verification
          ls -la lobby-*-${{ matrix.os }}-${{ matrix.arch }}*
          ls -la map-*-${{ matrix.os }}-${{ matrix.arch }}*

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: binaries-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            lobby-*-${{ matrix.os }}-${{ matrix.arch }}*
            map-*-${{ matrix.os }}-${{ matrix.arch }}*
          retention-days: 7

  compile-check:
    name: Compile Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check compilation
        run: |
          go build -v ./cmd/lobby-auth
          go build -v ./cmd/lobby-data
          go build -v ./cmd/lobby-view
          go build -v ./cmd/map-router
          go build -v ./cmd/map-instance
          go vet ./...
